<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست ثبت نام کاربر</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">ثبت نام کاربر جدید</h1>
        <p class="text-gray-600 mb-6 text-center">
            این فرم برای تست endpoint <code class="bg-gray-200 px-1 rounded">auth/register</code> طراحی شده است.
        </p>
        
        <!-- فرم ثبت نام -->
        <form id="registrationForm" class="space-y-4">
            <div>
                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">نام و نام خانوادگی</label>
                <input type="text" id="fullName" name="fullName" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">ایمیل</label>
                <input type="email" id="email" name="email" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
            </div>
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">شماره تلفن</label>
                <input type="tel" id="phone" name="phone" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
            </div>
            
            <!-- دکمه ارسال و نمایش پیام -->
            <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                ثبت نام
            </button>
        </form>
        
        <!-- نمایش پیام موفقیت یا خطا -->
        <div id="messageBox" class="mt-6 p-4 rounded-md hidden"></div>

    </div>

    <script>
        document.getElementById('registrationForm').addEventListener('submit', async function(event) {
            // جلوگیری از ارسال فرم به صورت پیش‌فرض
            event.preventDefault();

            // دریافت المان‌های فرم و پیام
            const form = event.target;
            const messageBox = document.getElementById('messageBox');
            const submitButton = form.querySelector('button[type="submit"]');

            // دریافت اطلاعات از فیلدها
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;

            // URL وب اپلیکیشن گوگل اسکریپت
            // لطفا در صورت تغییر، این لینک را به روز رسانی کنید.
            const scriptUrl = "https://script.google.com/macros/s/AKfycbzURoRSrwRuWxnuAeLUfcdOfiRUNfVzqJ63nvg0GjM2e-Pxixg9nmFYwe-HGXBf6LAdsA/exec";
            
            // نمایش وضعیت لودینگ
            messageBox.textContent = 'در حال ارسال اطلاعات...';
            messageBox.className = 'mt-6 p-4 rounded-md text-blue-800 bg-blue-50';
            messageBox.style.display = 'block';
            submitButton.disabled = true;
            submitButton.textContent = 'در حال ارسال...';
            
            try {
                // ارسال درخواست POST به endpoint ثبت نام
                const response = await fetch(`${scriptUrl}?pathInfo=auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        full_name: fullName,
                        email: email,
                        phone: phone
                    })
                });

                // بررسی پاسخ و نمایش نتیجه
                if (!response.ok) {
                    console.error('API Error:', response.status, response.statusText);
                    throw new Error(`Server returned status: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.ok) {
                    // نمایش پیام موفقیت
                    messageBox.innerHTML = `
                        <p class="font-bold text-green-800">✅ ثبت نام با موفقیت انجام شد!</p>
                        <ul class="list-disc list-inside mt-2 text-sm text-green-700">
                            <li>کد عضویت: <strong>${data.data.member_id}</strong></li>
                            <li>پین: <strong>${data.data.pin}</strong></li>
                        </ul>
                        <p class="text-xs mt-2">این اطلاعات در شیت 'Members' ثبت شده است.</p>
                    `;
                    messageBox.className = 'mt-6 p-4 rounded-md text-green-800 bg-green-50';
                } else {
                    // نمایش پیام خطا
                    messageBox.innerHTML = `<p class="font-bold text-red-800">❌ خطا: ${data.error}</p>`;
                    messageBox.className = 'mt-6 p-4 rounded-md text-red-800 bg-red-50';
                }

            } catch (error) {
                // مدیریت خطاهای شبکه
                console.error('Network Error:', error);
                // پیام خطای جدید و واضح‌تر برای کاربر
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    messageBox.innerHTML = `
                        <p class="font-bold text-red-800">❌ خطای شبکه: ارتباط با سرور برقرار نشد.</p>
                        <p class="text-sm mt-2 text-red-700">این خطا اغلب به دلیل مشکلات CORS یا باز کردن فایل HTML به صورت محلی رخ می‌دهد. لطفاً بررسی کنید که وب‌اپلیکیشن Google Apps Script شما به صورت عمومی (با دسترسی برای 'Anyone') منتشر شده باشد و فایل HTML را از روی یک سرور وب (مانند GitHub Pages) اجرا کنید.</p>
                    `;
                } else {
                    messageBox.innerHTML = `<p class="font-bold text-red-800">❌ خطای ناشناس: ${error.message}</p>`;
                }
                messageBox.className = 'mt-6 p-4 rounded-md text-red-800 bg-red-50';
            } finally {
                // بازگرداندن دکمه به حالت اولیه
                submitButton.disabled = false;
                submitButton.textContent = 'ثبت نام';
            }
        });
    </script>
</body>
</html>
