<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت باشگاه</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #24292f;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #444c56;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #57606a;
        }
        /* Hover effect for buttons */
        .btn-hover {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">
    
    <!-- Navigation Bar -->
    <header class="bg-gray-800/80 backdrop-blur-sm shadow-lg p-4 sticky top-0 z-50">
        <nav class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-teal-400">پنل مدیریت باشگاه</h1>
            <div id="nav-links" class="flex gap-4">
                <!-- Links will be added dynamically by JS -->
            </div>
            <button id="logout-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full btn-hover">
                خروج
            </button>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-6 flex flex-col items-center justify-center">
        <!-- Message Box -->
        <div id="message-box" class="w-full max-w-md p-4 mb-6 rounded-lg shadow-xl text-center hidden transform transition-all duration-300"></div>

        <!-- Dynamic Content View -->
        <div id="app-view" class="w-full max-w-xl bg-gray-800 rounded-3xl shadow-2xl p-8 border border-gray-700 transform transition-all duration-500">
            <!-- Content will be rendered here based on the current view -->
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-800/80 backdrop-blur-sm shadow-inner p-4 mt-6 text-center text-gray-400">
        <p>&copy; 2024 Gym Admin. تمامی حقوق محفوظ است.</p>
    </footer>

    <script>
        // Set up the Google Apps Script API endpoint URL
        const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzf69BLCG5TQ5PtTyJuxrIT8ICKXFhtABDoQz5zDypX6uOrtj-TBH6-XjacICn-_EmQPg/exec';

        // Get DOM elements
        const appView = document.getElementById('app-view');
        const messageBox = document.getElementById('message-box');
        const navLinks = document.getElementById('nav-links');
        const logoutBtn = document.getElementById('logout-btn');
        let currentView = 'login';
        let userToken = localStorage.getItem('gymAdminToken');

        // Function to display messages in the message box
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = 'w-full max-w-md p-4 mb-6 rounded-lg shadow-xl text-center transition-all duration-300 ' + (
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            );
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        // Handle logout
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('gymAdminToken');
            userToken = null;
            showMessage('با موفقیت از سیستم خارج شدید.');
            renderView('login');
        });

        // Function to make API calls
        async function apiCall(path, method = 'POST', body = null) {
            const headers = {
                'Content-Type': 'application/json',
            };
            if (userToken) {
                headers['Authorization'] = `Bearer ${userToken}`;
            }

            try {
                const response = await fetch(`${API_ENDPOINT}?pathInfo=${path}`, {
                    method: method,
                    headers: headers,
                    body: body ? JSON.stringify(body) : null
                });

                const data = await response.json();
                if (!response.ok || !data.ok) {
                    throw new Error(data.error || 'خطای ناشناخته');
                }
                return data.data;
            } catch (error) {
                showMessage(`خطا: ${error.message}`, 'error');
                console.error('API Error:', error);
                return null;
            }
        }

        // Render different views based on the state
        function renderView(viewName) {
            currentView = viewName;
            appView.innerHTML = ''; // Clear previous content
            navLinks.innerHTML = ''; // Clear nav links
            
            // Show/hide logout button
            if (userToken) {
                logoutBtn.classList.remove('hidden');
            } else {
                logoutBtn.classList.add('hidden');
            }

            switch (viewName) {
                case 'login':
                    renderLoginForm();
                    navLinks.innerHTML = `
                        <button onclick="renderView('register')" class="text-gray-400 hover:text-teal-400 transition-colors duration-300 btn-hover">ثبت‌نام</button>
                    `;
                    break;
                case 'register':
                    renderRegisterForm();
                    navLinks.innerHTML = `
                        <button onclick="renderView('login')" class="text-gray-400 hover:text-teal-400 transition-colors duration-300 btn-hover">ورود</button>
                    `;
                    break;
                case 'dashboard':
                    renderDashboard();
                    navLinks.innerHTML = `
                        <button onclick="renderView('attendance')" class="text-gray-400 hover:text-teal-400 transition-colors duration-300 btn-hover">ثبت حضور</button>
                        <button onclick="renderView('weights')" class="text-gray-400 hover:text-teal-400 transition-colors duration-300 btn-hover">ثبت وزن</button>
                    `;
                    break;
                case 'attendance':
                    renderAttendanceForm();
                    navLinks.innerHTML = `
                        <button onclick="renderView('dashboard')" class="text-gray-400 hover:text-teal-400 transition-colors duration-300 btn-hover">داشبورد</button>
                    `;
                    break;
                case 'weights':
                    renderWeightsForm();
                    navLinks.innerHTML = `
                        <button onclick="renderView('dashboard')" class="text-gray-400 hover:text-teal-400 transition-colors duration-300 btn-hover">داشبورد</button>
                    `;
                    break;
                default:
                    renderLoginForm();
            }
        }

        // Render Login Form
        function renderLoginForm() {
            appView.innerHTML = `
                <h2 class="text-3xl font-extrabold text-white text-center mb-6">ورود به پنل باشگاه</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="member_id" class="block text-sm font-medium text-gray-400">کد عضویت</label>
                        <input type="text" id="member_id" name="member_id" required
                            class="mt-1 block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300 placeholder-gray-500">
                    </div>
                    <div>
                        <label for="pin" class="block text-sm font-medium text-gray-400">کد پین</label>
                        <input type="password" id="pin" name="pin" required
                            class="mt-1 block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300 placeholder-gray-500">
                    </div>
                    <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl btn-hover shadow-lg">
                        ورود
                    </button>
                </form>
            `;
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const member_id = document.getElementById('member_id').value;
                const pin = document.getElementById('pin').value;
                const result = await apiCall('auth/login-code', 'POST', { member_id, pin });
                if (result) {
                    localStorage.setItem('gymAdminToken', result.token);
                    userToken = result.token;
                    showMessage('ورود با موفقیت انجام شد');
                    renderView('dashboard');
                }
            });
        }

        // Render Registration Form
        function renderRegisterForm() {
            appView.innerHTML = `
                <h2 class="text-3xl font-extrabold text-white text-center mb-6">ثبت‌نام کاربر جدید</h2>
                <form id="register-form" class="space-y-6">
                    <div>
                        <label for="full_name" class="block text-sm font-medium text-gray-400">نام و نام خانوادگی</label>
                        <input type="text" id="full_name" name="full_name" required
                            class="mt-1 block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300 placeholder-gray-500">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-400">ایمیل</label>
                        <input type="email" id="email" name="email" required
                            class="mt-1 block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300 placeholder-gray-500">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-400">شماره تلفن</label>
                        <input type="tel" id="phone" name="phone" required
                            class="mt-1 block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300 placeholder-gray-500">
                    </div>
                    <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl btn-hover shadow-lg">
                        ثبت‌نام
                    </button>
                </form>
            `;
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const full_name = document.getElementById('full_name').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;
                const result = await apiCall('auth/register', 'POST', { full_name, email, phone });
                if (result) {
                    showMessage(`ثبت‌نام موفقیت‌آمیز! کد عضویت شما: ${result.member_id} و پین: ${result.pin}. لطفاً این اطلاعات را یادداشت کنید.`);
                    renderView('login');
                }
            });
        }

        // Render Dashboard View
        async function renderDashboard() {
            const user = await apiCall('auth/me', 'GET');
            if (user) {
                appView.innerHTML = `
                    <div class="space-y-6 text-center">
                        <h2 class="text-3xl font-extrabold text-white">خوش آمدید، <span class="text-teal-400">${user.full_name}!</span></h2>
                        <div class="bg-gray-700 rounded-2xl shadow-inner p-6 space-y-4 text-left border border-gray-600">
                            <p class="text-lg flex justify-between items-center">
                                <span class="text-gray-400">کد عضویت:</span>
                                <span class="text-white font-mono">${user.member_id}</span>
                            </p>
                            <div class="h-px bg-gray-600"></div>
                            <p class="text-lg flex justify-between items-center">
                                <span class="text-gray-400">ایمیل:</span>
                                <span class="text-white font-mono">${user.email}</span>
                            </p>
                            <div class="h-px bg-gray-600"></div>
                            <p class="text-lg flex justify-between items-center">
                                <span class="text-gray-400">وضعیت:</span>
                                <span class="font-bold text-green-400">${user.status}</span>
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        // Render Attendance Form
        function renderAttendanceForm() {
            appView.innerHTML = `
                <h2 class="text-3xl font-extrabold text-white text-center mb-6">ثبت حضور</h2>
                <form id="attendance-form" class="space-y-6">
                    <div>
                        <label for="attendance_member_id" class="block text-sm font-medium text-gray-400">کد عضویت</label>
                        <input type="text" id="attendance_member_id" name="member_id" required
                            class="mt-1 block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300 placeholder-gray-500">
                    </div>
                    <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl btn-hover shadow-lg">
                        ثبت حضور
                    </button>
                </form>
            `;
            document.getElementById('attendance-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const member_id = document.getElementById('attendance_member_id').value;
                const result = await apiCall('attendance/check', 'POST', { member_id });
                if (result) {
                    showMessage('حضور با موفقیت ثبت شد');
                }
            });
        }

        // Render Weights Form
        function renderWeightsForm() {
            appView.innerHTML = `
                <h2 class="text-3xl font-extrabold text-white text-center mb-6">ثبت وزن</h2>
                <form id="weights-form" class="space-y-6">
                    <div>
                        <label for="weights_member_id" class="block text-sm font-medium text-gray-400">کد عضویت</label>
                        <input type="text" id="weights_member_id" name="member_id" required
                            class="mt-1 block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300 placeholder-gray-500">
                    </div>
                    <div>
                        <label for="weight_kg" class="block text-sm font-medium text-gray-400">وزن (کیلوگرم)</label>
                        <input type="number" id="weight_kg" name="weight_kg" step="0.1" required
                            class="mt-1 block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300 placeholder-gray-500">
                    </div>
                    <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl btn-hover shadow-lg">
                        ثبت وزن
                    </button>
                </form>
            `;
            document.getElementById('weights-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const member_id = document.getElementById('weights_member_id').value;
                const weight_kg = parseFloat(document.getElementById('weight_kg').value);
                const result = await apiCall('weights/add', 'POST', { member_id, weight_kg });
                if (result) {
                    showMessage('وزن با موفقیت ثبت شد');
                }
            });
        }

        // Initial render based on token existence
        document.addEventListener('DOMContentLoaded', () => {
            if (userToken) {
                renderView('dashboard');
            } else {
                renderView('login');
            }
        });
    </script>
</body>
</html>
